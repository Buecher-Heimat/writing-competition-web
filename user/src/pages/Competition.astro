---
import qs from "qs";

type AgeGroup = [number, number?];

const ageGroups: AgeGroup[] = [[16, 21], [22, 28], [29, 40], [41, 60], [61]];

const startDate: Date = new Date("2024-01-02");
const endDate: Date = new Date("2024-05-30");

import GuideStep from "../components/GuideStep.astro";
import PostCard from "../components/PostCard.astro";
import Layout from "../layouts/Layout.astro";

import { ArrowDown, ArrowRight, FileUp, PenTool } from "lucide-vue-next";

// ----- FETCH DATA -----

// Get the last part of the path
const { page } = Astro.params;

const url = Astro.request.url;
const queryParams = qs.parse(url.split("?")[1]);

// GET COMPETITION DATA
const competitionsResponse = await fetch(
  import.meta.env.PUBLIC_BACKEND_URL + "/api/competitions/" + queryParams.id
);

const competitionData = await competitionsResponse.json();

// GET POSTS
const query = {
  "competition.title": {
    equals: competitionData.title,
  },
};

const stringifiedQuery = qs.stringify({
  where: query,
});

const postsResponse = await fetch(
  import.meta.env.PUBLIC_BACKEND_URL + "/api/posts?" + stringifiedQuery
);

let posts = (await postsResponse.json()).docs;

posts = posts.slice(0, 6);

if (posts.length < 6) {
  posts = posts.slice(0, 3);
}

// GET MEDIA

// Get Hero Image
const heroImageResponse = await fetch(
  import.meta.env.PUBLIC_BACKEND_URL +
    "/api/media/" +
    competitionData.image_hero
);

const heroImage = await heroImageResponse.json();

console.log("Hero Image:" + competitionData.image_hero.url);

// Get Sponsor Logo(s)
let sponsorLogos: any[] = [];

console.log("Sponsors:" + competitionData.sponsors);

competitionData.sponsors.forEach(async (sponsor: any) => {
  sponsorLogos.push(sponsor.logo);
});

console.log("Logos:" + sponsorLogos);
---

<Layout title="Schreibwettbewerbe Bad Harzburg">
  <main>
    <section
      class="min-h-[90vh] w-screen flex flex-row 2xl:flex-col items-center justify-center relative px-52 xl:px-36 md:px-28 sm:px-4 py-20 gap-14"
    >
      <div class="absolute w-full h-full z-[-1] md:hidden">
        <img
          class="absolute left-[35%] top-16 lg:w-28"
          src="/images/shapes/three.svg"
          alt="Some shapes"
        />
        <img
          class="absolute left-[8%] top-[30%] lg:w-16"
          src="/images/shapes/two1.svg"
          alt="Some shapes"
        />
        <img
          class="absolute left-[-4%] bottom-0 lg:w-28 -rotate-45"
          src="/images/shapes/three.svg"
          alt="Some shapes"
        />
        <img
          class="absolute right-[50%] bottom-10 lg:w-28 rotate-12"
          src="/images/shapes/one.svg"
          alt="Some shapes"
        />
      </div>
      <img
        class="min-w-[36rem] h-[36rem] md:min-w-[24rem] md:h-[24rem] rounded-2xl shadow-2xl object-cover"
        src="/images/baustelle.png"
        alt="Ein Blick auf die Baustelle der B4 in Bad Harzburg"
      />
      <div
        class="w-[46rem] 2xl:w-full h-[36rem] 2xl:h-full py-4 flex flex-col justify-between 2xl:gap-8"
      >
        <h1
          class="text-twine-400 font-bold font-serif small-caps text-8xl 2xl:text-center lg:text-6xl leading-[6rem]"
        >
          {competitionData.title}
        </h1>
        <h2
          class="text-3xl lg:text-2xl font-bold small-caps text-bandicoot-400 mt-3 2xl:text-center leading-8"
        >
          {competitionData.sponsor_string}
        </h2>
        <div
          class="flex flex-row md:flex-col justify-between 2xl:justify-evenly md:items-center gap-2"
        >
          <div class="md:flex md:flex-col md:items-center">
            <h3 class="text-bandicoot-400 font-bold text-basic mt-5 mb-2">
              Altersgruppen
            </h3>
            <ul class="flex flex-wrap md:justify-center gap-1">
              {
                competitionData.agegroups.map((agegroup: any) => (
                  <li class="w-24 h-8 border-[1px] text-sm border-bandicoot-400 rounded-lg px-2 py-1 text-bandicoot-400 flex justify-center items-center">
                    {agegroup.age_end
                      ? `${agegroup.age_end}-${agegroup.age_start}`
                      : `${agegroup.age_start}+`}{" "}
                    Jahre
                  </li>
                ))
              }
            </ul>
          </div>
          <div class="md:flex md:flex-col md:items-center">
            <h3 class="text-bandicoot-400 font-bold text-basic mt-5 mb-2">
              Zeitraum
            </h3>
            <div
              class="h-8 bg-bandicoot-400 flex gap-2 rounded-md w-[fit-content] px-2 py-1 font-semibold text-pearl-bush-50 justify-center items-center"
            >
              {new Date(competitionData.date_start).toLocaleDateString("de-DE")}
              <span class="font-thin">bis</span>
              {new Date(competitionData.date_end).toLocaleDateString("de-DE")}
            </div>
          </div>
        </div>
        <div
          class="flex flex-row md:flex-col 2xl:justify-center items-center gap-2"
        >
          <button
            class="w-52 hover:bg-transparent bg-twine-400 hover:text-twine-400 border-[1px] border-twine-400 text-pearl-bush-50 transition-colors ease-out duration-500 text-lg sm:text-sm font-serif font-semibold flex flex-row gap-2 items-center rounded-lg py-2 px-4 justify-evenly"
          >
            Mitmachen
            <FileUp size="1.5rem" />
          </button>
          <button
            class="w-52 hover:bg-bandicoot-400 hover:text-pearl-bush-50 transition-colors ease-out duration-500 text-lg sm:text-sm font-serif font flex flex-row gap-2 items-center rounded-lg border-[1px] py-2 px-4 font-semibold border-bandicoot-400 text-bandicoot-400 justify-evenly"
          >
            Mehr erfahren
            <ArrowDown size="1.5rem" />
          </button>
        </div>
      </div>
    </section>
    <section
      class="w-screen bg-white flex flex-wrap items-center justify-center py-8 px-8"
    >
      <img
        class="h-18"
        src="/images/logos/oeffentliche.png"
        alt="Das Logo der Öffentlichen Versicherung Braunschweig"
      />
      <img
        class="h-18"
        src="/images/logos/oeffentliche.png"
        alt="Das Logo der Öffentlichen Versicherung Braunschweig"
      />
    </section>
    <section
      class="w-screen bg-bandicoot-400 pl-36 pr-52 py-20 xl:pl-20 xl:pr-36 md:pl-12 md:pr-28"
    >
      <h1
        class="text-pearl-bush-100 font-bold flex flex-col font-serif small-caps text-8xl lg:text-6xl mb-14 ml-16 leading-[5rem] gap-4"
      >
        So geht's
        <span class="text-3xl uppercase font-sans font-light italic">
          Es ist eigentlich ganz einfach
        </span>
      </h1>
      <div class="grid grid-cols-2 lg:grid-cols-1 gap-8 z-10 relative">
        {
          competitionData.instruction_steps.map((step: any, index: number) => (
            <GuideStep
              title={step.title}
              number={index + 1}
              description={step.description}
              textColor="text-pearl-bush-100"
            />
          ))
        }
      </div>
    </section>
    <section class="w-screen relative">
      <div class="absolute w-full h-full z-[-1] md:hidden">
        <img
          class="absolute right-[5%] -top-2 lg:w-28 -rotate-45"
          src="/images/shapes/two1.svg"
          alt="Some shapes"
        />
        <img
          class="absolute left-[2%] top-20 lg:w-16 rotate-45"
          src="/images/shapes/three.svg"
          alt="Some shapes"
        />
        <img
          class="absolute left-[8%] bottom-12 lg:w-28 rotate-12"
          src="/images/shapes/two1.svg"
          alt="Some shapes"
        />
        <img
          class="absolute right-[15%] -bottom-10 lg:w-28 rotate-90"
          src="/images/shapes/three.svg"
          alt="Some shapes"
        />
        <img
          class="absolute right-[45%] top-40 lg:w-28 rotate-12"
          src="/images/shapes/one.svg"
          alt="Some shapes"
        />
      </div>
      <div class="px-36 py-20 xl:px-20">
        <div class="mb-14 lg:text-center">
          <h2
            class="small-caps font-serif text-4xl font-bold text-pearl-bush-950"
          >
            Deine Konkurrenz
          </h2>
          <h3 class="font-bold text-basic text-bandicoot-400">
            Diese Texte haben andere einreicht.
          </h3>
        </div>
        <div
          class="grid grid-cols-3 2xl:grid-cols-2 lg:grid-cols-1 gap-6 justify-items-center"
        >
          {
            posts.map((post: any) => (
              <PostCard
                title={post.title}
                winner={post.winner}
                author={post.author}
                competition={post.competition.title}
                ageGroup={[post.agegroup.age_start, post.agegroup.age_end]}
                date={new Date(post.createdAt)}
                excerpt={post.content}
              />
            ))
          }
        </div>
        <div class="flex justify-end lg:justify-center mt-14">
          <button
            class="w-fit hover:bg-bandicoot-400 hover:text-pearl-bush-50 transition-colors ease-out duration-500 text-lg sm:text-sm font-serif font flex flex-row gap-2 items-center rounded-lg border-[1px] py-2 px-4 font-semibold border-bandicoot-400 text-bandicoot-400 bg-pearl-bush-100 justify-evenly"
          >
            Alle Texte
            <ArrowRight size="1.5rem" />
          </button>
        </div>
      </div>
    </section>
    <section
      class="w-screen bg-bandicoot-400 basis-2/3 flex flex-row 2xl:flex-col justify-around px-52 xl:px-36 md:px-28 py-20 gap-28"
    >
      <div class="w-[58rem] 2xl:w-full flex flex-col">
        <h1
          class="text-pearl-bush-100 font-bold flex flex-col font-serif small-caps text-8xl lg:text-6xl mb-14 leading-[5rem] gap-4"
        >
          Bevor du loslegst
          <span class="text-3xl uppercase font-sans font-light italic"
            >Ein Paar Tipps zum Schreiben deines Textes
          </span>
        </h1>
        <div class="flex flex-col gap-6 text-pearl-bush-100">
          <span
            >Überlege Dir, in welcher Zeit (Gegenwart oder Vergangenheit) und
            aus welcher Erzählperspektive (aus der Ich-Perspektive oder lieber
            in der dritten Person - er, sie -) Du schreiben möchtest. Versuche
            es ruhig auf unterschiedliche Arten und schau, was Dir mehr liegt.</span
          >
          <span
            >Wähle einen Inhalt, der Dir wirklich am Herzen liegt, man wird
            Deiner Geschichte anmerken, wenn Du voll hinter ihr stehst. Bedenke
            bei der Wahl Deiner Überschrift, dass sie neugierig auf Deine
            Geschichte machen sollte und zum Inhalt passt.</span
          >
          <span
            >Achte darauf, dass Du keine Begriffe verwendest, die Du nicht
            wirklich kennst. Achte auf die korrekte Verwendung von Zeiten, falls
            Du unterschiedliche Zeitebenen benutzt.</span
          >
          <span
            >Lass ein Rechtschreibprogramm Deine Geschichte prüfen und dann eine
            oder besser mehrere Personen aus Deinem Umfeld den Text lesen und
            auf Verständlichkeit und nochmals Rechtschreibung korrigieren (das
            macht auch jede*r bekannte Autor*in).</span
          >
        </div>
      </div>
      <div class="flex items-center justify-center">
        <div
          class="min-w-[20rem] min-h-[20rem] bg-pearl-bush-100 rounded-full flex items-center justify-center"
        >
          <PenTool class="text-twine-400" size="150" />
        </div>
      </div>
    </section>
    <section class="w-screen flex justify-center pt-20 pb-40 relative">
      <div class="absolute w-full h-full z-[-1] md:hidden">
        <img
          class="absolute -right-[1%] top-10 lg:w-28 rotate-45"
          src="/images/shapes/three.svg"
          alt="Some shapes"
        />
        <img
          class="absolute right-[18%] bottom-8 lg:w-28 rotate-45"
          src="/images/shapes/two1.svg"
          alt="Some shapes"
        />
        <img
          class="absolute left-[0%] top-8 lg:w-16 rotate-180"
          src="/images/shapes/two1.svg"
          alt="Some shapes"
        />
        <img
          class="absolute left-[18%] bottom-8 lg:w-28 rotate-12"
          src="/images/shapes/three.svg"
          alt="Some shapes"
        />
        <img
          class="absolute left-[45%] bottom-32 lg:w-28 rotate-12"
          src="/images/shapes/one.svg"
          alt="Some shapes"
        />
        <img
          class="absolute left-[8%] bottom-12 lg:w-28"
          src="/images/shapes/one.svg"
          alt="Some shapes"
        />
      </div>
      <div class="w-[32rem] flex flex-col items-center gap-12">
        <h1
          class="text-bandicoot-400 font-bold font-serif small-caps text-5xl text-center md:text-4xl"
        >
          Worauf wartest Du noch?!
        </h1>
        <button
          class="w-80 hover:bg-transparent bg-twine-400 hover:text-twine-400 border-[1px] border-twine-400 text-pearl-bush-50 transition-colors ease-out duration-500 text-lg sm:text-sm font-serif font-semibold flex flex-row gap-2 items-center rounded-lg py-2 px-4 justify-evenly"
        >
          Mitmachen
        </button>
      </div>
    </section>
  </main>
</Layout>
